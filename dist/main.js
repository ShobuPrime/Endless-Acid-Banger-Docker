(()=>{"use strict";function e(e){return Math.floor(Math.random()*(e-.01))}function t(t){return t[e(t.length)]}var n=function(e,t,n,a){return new(n||(n=Promise))((function(o,r){function c(e){try{u(a.next(e))}catch(e){r(e)}}function i(e){try{u(a.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,i)}u((a=a.apply(e,t||[])).next())}))};const a=new Map,o=new Map;function r(e){const t=e.substring(e.length-1),n=e.substring(0,e.length-1);return 12*parseInt(t)+a.get(n)+12}function c(e){return 440*Math.pow(2,(e-69)/12)}function i(e=new(window.AudioContext||window.webkitAudioContext)){function t(){if(e.createConstantSource)return e.createConstantSource();{const t=e.createBufferSource();t.buffer=e.createBuffer(1,256,e.sampleRate);const n=t.buffer.getChannelData(0);for(let e=0;e<n.length;e++)n[e]=1;const a=e.createGain(),o=a.gain;return t.loop=!0,t.connect(a),Object.assign(a,{offset:o,start:()=>t.start()})}}const a=function(){const t=e.createGain();t.gain.value=.5;const n=e.createDynamicsCompressor();n.attack.value=.005,n.release.value=.1,n.ratio.value=15,n.knee.value=0,n.threshold.value=-.5;const a=e.createAnalyser();return a.fftSize=2048,n.connect(a),t.connect(n),n.connect(e.destination),{in:t,analyser:a}}();function o(e){return new Promise((t=>{setTimeout((()=>t()),1e3*e)}))}function i(t,r,c,i,u=0,s=a.in){return n(this,void 0,void 0,(function*(){const n=e.createOscillator();n.type="sawtooth",n.frequency.value=t,n.start();const a=e.createBiquadFilter();a.type="lowpass",a.frequency.value=4*t,a.Q.value=5;const l=e.createGain();l.gain.value=0;const d=e.createPanner();d.panningModel="equalpower",d.setPosition(u,0,1-Math.abs(u)),n.connect(a),a.connect(l),l.connect(d),d.connect(s),l.gain.linearRampToValueAtTime(.1,e.currentTime+r),yield o(c+r),l.gain.setValueAtTime(.1,e.currentTime),l.gain.linearRampToValueAtTime(0,e.currentTime+i),a.frequency.linearRampToValueAtTime(Math.max(t/2,400),e.currentTime+i),yield o(i+.01),n.stop(e.currentTime),d.disconnect()}))}function u(t){return n(this,void 0,void 0,(function*(){const o=yield function(t){return n(this,void 0,void 0,(function*(){const n=yield fetch(t),a=yield n.arrayBuffer();var o;return yield(o=a,new Promise(((t,n)=>e.decodeAudioData(o,t,n))))}))}(t);return{play:function(t=.4,n=1,r=a.in){const c=e.createBufferSource();c.buffer=o,c.loop=!1;const i=e.createGain();i.gain.setValueAtTime(t,e.currentTime),i.gain.linearRampToValueAtTime(0,e.currentTime+n),c.connect(i),i.connect(r),c.start(e.currentTime)}}}))}return{tone:i,SimpleToneSynth:function(e,t,n,o=a.in){return{play:function(a){i(function(e){return c("number"==typeof e?e:r(e))}(a),e,t,n,2*Math.random()-1,o)}}},DelayInsert:function(t,n,o,r=a.in){const c=e.createDelay(1);c.delayTime.value=t;const i=e.createGain();i.gain.value=n,c.connect(i),i.connect(c);const u=e.createGain();u.gain.value=o,c.connect(u),u.connect(r);const s=e.createGain();return s.gain.value=1,s.connect(c),s.connect(r),{in:s,feedback:i.gain,wet:u.gain,delayTime:c.delayTime}},ThreeOh:function(n="sawtooth",o=a.in){const i=e.createBiquadFilter();i.type="lowpass",i.Q.value=20,i.frequency.value=300;const u=i.Q,s=i.frequency,l=t();l.start();const d=l.offset,f=t();f.start(),f.offset.value=0;const m=e.createGain();m.gain.value=4e3;const v=m.gain;f.connect(m),m.connect(i.detune);const h=e.createOscillator();h.type=n,h.frequency.value=440,h.start();const g=e.createGain();return g.gain.value=0,h.connect(g),g.connect(i),i.connect(o),{noteOn:function(t,n=!1,a=!1){n?(f.offset.cancelScheduledValues(e.currentTime),f.offset.setValueAtTime(1,e.currentTime),f.offset.exponentialRampToValueAtTime(.01,e.currentTime+d.value/3)):(f.offset.cancelScheduledValues(e.currentTime),f.offset.setValueAtTime(1,e.currentTime),f.offset.exponentialRampToValueAtTime(.01,e.currentTime+d.value)),h.frequency.cancelScheduledValues(e.currentTime),h.frequency.setTargetAtTime(c(r(t)),e.currentTime,a?.02:.002),g.gain.cancelScheduledValues(e.currentTime),g.gain.setValueAtTime(n?.2:.15,e.currentTime),g.gain.linearRampToValueAtTime(.1,e.currentTime+.2)},noteOff:function(){g.gain.cancelScheduledValues(e.currentTime),g.gain.setTargetAtTime(0,e.currentTime,.01)},params:{cutoff:s,resonance:u,envMod:v,decay:d}}},kick:function(t=a.in){const n=e.createOscillator();n.frequency.value=400;const o=e.createGain();o.gain.value=.3,n.start(),n.frequency.exponentialRampToValueAtTime(50,e.currentTime+.04),o.gain.setValueCurveAtTime([.5,.5,.45,.4,.25,0],e.currentTime,.09),n.stop(e.currentTime+.1),window.setTimeout((()=>o.disconnect()),200),n.connect(o),o.connect(t)},Sampler:u,SamplerDrumMachine:function(t,o=a.in){return n(this,void 0,void 0,(function*(){const n=e.createGain();n.gain.value=1,n.connect(o);const a=t.map(u);return{triggers:(yield Promise.all(a)).map((e=>({play:t=>e.play(.7*t,.5*t,n)})))}}))},master:a,context:e}}function u(e,t){let n=[];const a={value:t};return{name:e,subscribe:function(e){e(a.value),n.push(e)},get value(){return a.value},set value(e){a.value=e,function(){for(let e of n)e(a.value)}()}}}function s(e,t=!1){return u(e,t)}function l(e,t,n){return Object.assign(u(e,n),{bounds:t})}function d(){let n=u("note set",["C1"]),a=s("new note set",!0);const r=[[0,0,12,24,27],[0,0,0,12,10,19,26,27],[0,1,7,10,12,13],[0],[0,0,0,12],[0,0,12,14,15,19],[0,0,0,0,12,13,16,19,22,24,25],[0,0,0,7,12,15,17,20,24]];return{createPattern:function(){1==a.value&&(function(){const a=e(15)+16,c=t(r);n.value=c.map((e=>function(e){const t=Math.floor(e/12),n=Math.floor(e%12);return`${o.get(n)}${t}`}(e+a)))}(),a.value=!1);const c=[];for(let e=0;e<16;e++){const a=1*(e%4==0?.6:e%3==0?.5:e%2==0?.3:.1);Math.random()<a?c.push({note:t(n.value),accent:Math.random()<.3,glide:Math.random()<.1}):c.push({note:"-",accent:!1,glide:!1})}return c},newNotes:a,noteSet:n}}function f(e){return e<0?0:e>1?1:e}(()=>{function e(e,t){a.set(e,t),o.set(t,e)}e("A",9),e("A#",10),e("B",11),e("C",0),e("C#",1),e("D",2),e("D#",3),e("E",4),e("F",5),e("F#",6),e("G",7),e("G#",8)})();const m={bg:"#222266",note:"#88aacc",accent:"#AA88CC",glide:"#CCAA88",text:"#CCCCFF",highlight:"rgba(255,255,255,0.2)",grid:"rgba(255,255,255,0.2)",dial:"#AA88CC"};function v(e,...t){const n=Array.isArray(e)?e:Object.keys(e).map((t=>e[t])),a=document.createElement("div");return a.classList.add("params",...t),n.forEach((e=>{const t=function(e,t,n="red",a="white"){const o=document.createElement("canvas");o.classList.add("dial");const r=o.width=70,c=o.height=50,i=o.getContext("2d");let u=.5,s=.5,l=0,d=null;function m(){i.clearRect(0,0,r,c);const e=[.8*Math.PI,2.2*Math.PI];i.strokeStyle=n,i.lineWidth=2,i.beginPath(),i.arc(r/2,c/2,20,e[0],e[1]),i.stroke(),i.lineWidth=r/8;const o=e[0]+u*(e[1]-e[0]);if(i.beginPath(),i.arc(r/2,c/2,20,o-.2,o+.2),i.stroke(),l>0){i.strokeStyle="rgba(0,255,0,"+f(l/10)+")",i.lineWidth=r/8;const t=e[0]+u*(e[1]-e[0]);i.beginPath(),i.arc(r/2,c/2,20,t-.2,t+.2),i.stroke()}if(t){i.fillStyle=a,i.font="10px Orbitron";const e=i.measureText(t).width;i.fillText(t,r/2-e/2,c/2+20)}}function v(t){return e[0]+(e[1]-e[0])*t}function h(t){var n;u=(t-e[0])/(e[1]-e[0]),m(),Math.abs(u-s)>.002&&(n=4+Math.floor(Math.abs(u-s)/.001),d&&window.clearInterval(d),l=Math.min(n,10),d=window.setInterval((()=>{l--,m()}),100)),s=u}const g={isDragging:!1,handler:[e=>{}]};return o.addEventListener("mousedown",(e=>{g.isDragging=!0})),window.addEventListener("mousemove",(e=>{if(g.isDragging){const t=(e.movementX-e.movementY)/100;u=f(u+t);const n=v(u);h(n),g.handler.forEach((e=>e(n)))}})),window.addEventListener("mouseup",(e=>{g.isDragging=!1})),m(),{element:o,get value(){return v(u)},set value(e){h(e)},bind:function(e){g.handler.push(e)}}}(e.bounds,e.name,m.dial,m.text);t.bind((t=>{e.value=t})),e.subscribe((e=>t.value=e)),a.append(t.element)})),a}function h(e){const t=document.createElement("button");return t.classList.add("trigger-button"),t.innerText="âŸ³",e.subscribe((e=>{e?t.classList.add("waiting"):t.classList.remove("waiting")})),t.addEventListener("click",(function(){e.value=!0})),t}function g(e,...t){const n=document.createElement("button");return n.classList.add(...t),n.innerText=e.name,n.addEventListener("click",(()=>e.value=!e.value)),e.subscribe((e=>{e?(n.classList.add("on"),n.classList.remove("off")):(n.classList.add("off"),n.classList.remove("on"))})),n}function p(e){const t=document.createElement("div");return t.classList.add("label"),t.innerText=e,t}function b(...e){const t=document.createElement("div");return t.classList.add("machine"),t.append(...e),t}function y(e,t,...n){const a=document.createElement("div");return a.classList.add("control-group",...n),a.append(e,t),a}function T(...e){const t=document.createElement("div");return t.classList.add("group"),t.append(...e),t}var w=function(e,t,n,a){return new(n||(n=Promise))((function(o,r){function c(e){try{u(a.next(e))}catch(e){r(e)}}function i(e){try{u(a.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,i)}u((a=a.apply(e,t||[])).next())}))};function M(e,t,n,a,o=16){const r=e.ThreeOh(t,n),c=u("Pattern",[]),i=s("New Pattern Trigger",!0);a.newNotes.subscribe((e=>{1==e&&(i.value=!0)}));const d={cutoff:l("Cutoff",[30,700],400),resonance:l("Resonance",[1,30],15),envMod:l("Env Mod",[0,8e3],4e3),decay:l("Decay",[.1,.9],.5)};return d.cutoff.subscribe((e=>r.params.cutoff.value=e)),d.resonance.subscribe((e=>r.params.resonance.value=e)),d.envMod.subscribe((e=>r.params.envMod.value=e)),d.decay.subscribe((e=>r.params.decay.value=e)),{step:function(e){(0===e&&1==i.value||0==c.value.length)&&(c.value=a.createPattern(),i.value=!1);const t=c.value[e%o];"-"!=t.note?r.noteOn(t.note,t.accent,t.glide):r.noteOff()},pattern:c,parameters:d,newPattern:i}}function k(e){return w(this,void 0,void 0,(function*(){const n=yield e.SamplerDrumMachine(["909BD.mp3","909OH.mp3","909CH.mp3","909SD.mp3"]),a=u("Drum Pattern",[]),o=[u("Mute BD",!1),u("Mute OH",!1),u("Mute CH",!1),u("Mute SD",!1)],r=s("New Pattern Trigger",!0),c=function(e=!1){const n=new Array(16),a=new Array(16),o=new Array(16),r=new Array(16),c=t(["electro","fourfloor"]),i=t(["offbeats","closed",e?"offbeats":"none"]),u=t(["backbeat","skip",e?"backbeat":"none"]);if("fourfloor"==c)for(let e=0;e<16;e++)e%4==0?n[e]=.9:e%2==0&&Math.random()<.1&&(n[e]=.6);else if("electro"==c)for(let e=0;e<16;e++)0==e?n[e]=1:(e%2==0&&e%8!=4&&Math.random()<.5||Math.random()<.05)&&(n[e]=.9*Math.random());if("backbeat"==u)for(let e=0;e<16;e++)e%8==4&&(r[e]=1);else if("skip"==u)for(let e=0;e<16;e++)e%8==3||e%8==6?r[e]=.6+.4*Math.random():e%2==0&&Math.random()<.2?r[e]=.4+.2*Math.random():Math.random()<.1&&(r[e]=.2+.2*Math.random());if("offbeats"==i)for(let e=0;e<16;e++)e%4==2?a[e]=.4:Math.random()<.3&&(Math.random()<.5?o[e]=.2*Math.random():a[e]=.2*Math.random());else if("closed"==i)for(let e=0;e<16;e++)e%2==0?o[e]=.4:Math.random()<.5&&(o[e]=.3*Math.random());return[n,a,o,r]};return{step:function(e){(0==e&&1==r.value||0==a.value.length)&&(a.value=c(!0),r.value=!1);for(let t in a.value){const r=a.value[t][e%a.value[t].length];r&&!o[t].value&&n.triggers[t].play(r)}},pattern:a,mutes:o,newPattern:r}}))}!function(e,t,n,a="Click, tap or press any key to start"){const o=document.createElement("button");o.id="_start_button";const r=document.createElement("div");r.id="_intro_text",o.append(r),r.innerHTML=t+"<br><br>"+n+"<br><br>"+a,document.head.insertAdjacentHTML("beforeend",`\n    <style>\n        body {\n            height: 95vh;  margin: 0; padding: 0; \n        }\n        #${o.id} {\n            width: 100%;\n            height: 100%;\n            display: block;\n            position: absolute;\n            top: 0;\n            left: 0;\n            z-index: 50;\n            color:grey;\n            background-color: black;\n        }\n        \n        #${r.id} {\n            max-width: 640px;\n            font-size: 1.5em;\n            margin-left: auto;\n            margin-right: auto;\n            text-align:left;\n            font-family: monospace;\n        }\n    </style>\n    `),document.body.append(o);let c=!1;function i(){c||(c=!0,e(),o.style.display="none")}o.addEventListener("click",i),window.addEventListener("keydown",i)}((function(){return w(this,void 0,void 0,(function*(){const e=i(),t=function(){const e=l("BPM",[70,200],142),t=l("Current Step",[0,15],0),n=function(e,t=4,n=0){let a=e,o=(e,t)=>{},r=(new Date).getTime(),c=0;return window.setTimeout((function e(){const i=(new Date).getTime()-r;o(i,c);const u=c%2==0?1+n:1-n;c++,window.setTimeout(e,u*(6e4/a)/t)}),6e4/e/t),{bind:function(e){o=e},setBpm:e=>a=e}}(e.value,4,0);return e.subscribe(n.setBpm),n.bind(((e,n)=>{t.value=n%16})),{bpm:e,currentStep:t}}(),n=function(e){const t=l("Dry/Wet",[0,.5],.5),n=l("Feedback",[0,.9],.3),a=l("Time",[0,2],.3),o=e.DelayInsert(a.value,t.value,n.value);return t.subscribe((e=>o.wet.value=e)),n.subscribe((e=>o.feedback.value=e)),a.subscribe((e=>o.delayTime.value=e)),{dryWet:t,feedback:n,delayTime:a,inputNode:o.in}}(e);t.bpm.subscribe((e=>n.delayTime.value=3/4*(60/e)));const a=d(),o={notes:[M(e,"sawtooth",n.inputNode,a),M(e,"square",n.inputNode,a)],drums:yield k(e),gen:a,delay:n,clock:t};t.currentStep.subscribe((e=>[...o.notes,o.drums].forEach((t=>t.step(e)))));const c=function(e){const t=l("upcomingMeasure",[0,1/0],0),n=l("measure",[0,1/0],0),a=u("Alter Patterns",!0),o=u("Twiddle With Knobs",!0),r=u("Mute Drum Parts",!0);e.clock.currentStep.subscribe((e=>{4===e?t.value=t.value+1:15===e&&(n.value=n.value+1)})),t.subscribe((t=>{a.value&&(t%64==0&&Math.random()<.2&&(e.gen.newNotes.value=!0),t%16==0&&(e.notes.forEach(((e,t)=>{Math.random()<.5&&(e.newPattern.value=!0)})),Math.random()<.3&&(e.drums.newPattern.value=!0)))})),n.subscribe((t=>{if(r.value&&t%8==0){const t=[Math.random()<.2,Math.random()<.5,Math.random()<.5,Math.random()<.5];e.drums.mutes[0].value=t[0],e.drums.mutes[1].value=t[1],e.drums.mutes[2].value=t[2],e.drums.mutes[3].value=t[3]}}));const c=[...e.notes.flatMap((e=>Object.values(e.parameters))),e.delay.feedback,e.delay.dryWet].map((e=>function(e,t=1/400){const[n,a]=e.bounds;let o=0,r=t*(a-n),c=0,i=(n+a)/2;return{step:()=>{i!=e.value?(o=0,i=e.value,c=200):(c>0&&c--,c<100&&(o*=c>0?.8:.98,o+=(Math.random()-.5)*r,e.value+=o,i=e.value,e.value>n+.8*(a-n)?o-=Math.random()*r:e.value<n+.2*(a-n)&&(o+=Math.random()*r)))}}}(e)));return window.setInterval((()=>{o.value&&c.forEach((e=>e.step()))}),100),{switches:[a,o,r]}}(o),s=function(e,t,n){const a=document.createElement("div");a.id="ui";const o=function(...e){const t=document.createElement("div");return t.classList.add("controls"),t.append(...e),t}(function(e){return y(p("Autopilot"),T(...e.switches.map((e=>g(e,"autopilot-button")))))}(t),function(e){const t=document.createElement("div");return t.classList.add("parameter-controlled","notegen-note-display"),e.noteSet.subscribe((e=>{t.innerText=e.join(", ")})),y(p("Notegen"),T(h(e.newNotes),t),"notegen-box")}(e.gen),function(e){const t=v([e.dryWet,e.feedback]);return t.classList.add("horizontal"),y(p("Delay"),t)}(e.delay),y(p("Clock"),v([e.clock.bpm],"horizontal")),y(p("Meter"),T(function(e){const t=document.createElement("canvas");t.style.width="100%";let n=t.width=200;const a=t.height=100,o=t.getContext("2d"),r=new Uint8Array(e.fftSize);return window.requestAnimationFrame((function t(){e.getByteTimeDomainData(r),o.clearRect(0,0,n,a),o.strokeStyle="white",o.beginPath(),o.moveTo(0,a/2);for(let e=0;e<r.length;e++){const t=r[e]/128-1;o.lineTo(n*e/r.length,a/2+1.5*t*a/2)}o.stroke(),window.requestAnimationFrame(t)})),t}(n)),"meter")),c=document.createElement("div");c.classList.add("machines");const i=e.notes.map(((t,n)=>b(p("303-0"+(n+1)),T(h(t.newPattern),function(e,t,n=m){const a=document.createElement("canvas");function o(){const o=e.value,c=a.width=a.clientWidth,i=a.height=200,u=i/50,s=a.getContext("2d");s.font="10px Orbitron",s.fillStyle=n.bg,s.fillRect(0,0,c,i),s.strokeStyle=n.grid;for(let e=0;e<o.length;e++){const t=c*e/o.length;s.beginPath(),s.moveTo(t,0),s.lineTo(t,i),s.stroke()}for(let e=0;e<80;e++){const t=i-e*u;s.beginPath(),s.moveTo(0,t),s.lineTo(c,t),s.stroke()}for(let e=0;e<o.length;e++){const t=o[e];if("-"===t.note);else{const a=r(t.note)-24,l=c*e/o.length,d=i-a*u,f=c/o.length,m=5;s.fillStyle=t.glide?n.glide:t.accent?n.accent:n.note,s.fillRect(l,d,f,m),s.fillStyle=n.text;const v=l+f/2-s.measureText(t.note).width/2;s.fillText(t.note,v,d)}}s.fillStyle=n.highlight,s.fillRect(c*t.value/o.length,0,c/o.length,i)}return a.classList.add("pattern"),e.subscribe(o),t.subscribe(o),a}(t.pattern,e.clock.currentStep),v(t.parameters))))),u=b(p("909-XX"),T(h(e.drums.newPattern),function(e,t,n,a=m){const o=document.createElement("canvas");function r(){const r=o.width=o.clientWidth,c=o.height=100,i=o.getContext("2d");i.fillStyle=a.bg,i.fillRect(0,0,r,c);for(let n=0;n<16;n++){const a=r*n/16;for(let o=0;o<e.value.length;o++){const u=o/e.value.length*c;e.value[o][n]&&(t[o].value?i.fillStyle="rgba(128,0,0,0.4)":i.fillStyle="rgba(136,170,204,"+e.value[o][n]+")",i.fillRect(a,u,r/16,c/e.value.length))}}i.fillStyle=a.highlight,i.fillRect(r*n.value/16,0,r/16,c)}return o.classList.add("pattern"),e.subscribe(r),n.subscribe(r),o}(e.drums.pattern,e.drums.mutes,e.clock.currentStep),function(e){const t=document.createElement("div");return t.classList.add("mutes"),t.append(...e.map((e=>g(e)))),t}(e.drums.mutes)));return c.append(...i,u),a.append(c,o),a}(o,c,e.master.analyser);document.body.append(s)}))}),"The Endless Acid Banger","A collaboration between human and algorithm by Vitling")})();